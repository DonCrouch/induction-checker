<!DOCTYPE html>
<html lang="en">
…
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('INIT induction-checker');

  // === Power Automate HTTP trigger URL (full URL incl. ?api-version&sp&sv&sig) ===
  const FLOW_URL = "https://defaultaf757c3f7ec14f43954fa0b9a650bd.ff.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3252a70df28245448294ec944ed25586/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=k4Jv77s-gPqxuDNaNqhThejSvFznEGY2WQYVUIorLRk";

  // --- Elements ---
  const form   = document.getElementById('f');
  const btn    = document.getElementById('go');
  const nameEl = document.getElementById('n');
  const sabreEl= document.getElementById('s');
  const ok     = document.getElementById('ok');
  const warn   = document.getElementById('warn');
  const err    = document.getElementById('err');

  function show(el, html){ if(!el) return; el.innerHTML = html; el.style.display='block'; }
  function hide(...els){ els.forEach(e => e && (e.style.display='none')); }

  // Guard: if any key element missing, bail with message
  if (!form || !btn || !nameEl || !sabreEl) {
    console.error('Init error: missing element(s)', {form, btn, nameEl, sabreEl});
    show(err, 'Setup error: missing form elements.');
    return;
  }

  async function handleCheck(e){
    if (e) e.preventDefault();
    hide(ok, warn, err);

    const fullName = (nameEl.value || '').trim();
    const sabreRef = (sabreEl.value || '').trim();

    console.log('CLICK', { fullName, sabreRef });

    if (!fullName || !sabreRef){
      show(err, '❌ Please enter both your name and SABRE reference.');
      return;
    }

    btn.disabled = true; btn.textContent = 'Checking…';

    try{
      const r = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ fullName, sabreRef })
      });

      const raw = await r.text();
      console.log('HTTP', r.status, raw);

      if (!r.ok) throw new Error(`HTTP ${r.status} ${raw}`);

      // Expecting flow to return JSON like:
      // { "result": "valid", "lastDate": "2025-10-06" }  OR  { "result": "needs" }
      const data = JSON.parse(raw);

      if (data.result === 'valid') {
        const d = data.lastDate ? new Date(data.lastDate).toLocaleDateString('en-GB') : '—';
        show(ok, `✅ Induction already completed on <b>${d}</b>.`);
      } else if (data.result === 'needs') {
        show(warn, '⚠️ No valid induction found. Please complete the modules below.');
      } else {
        show(err, 'Unexpected response from server.');
      }
    } catch(e2){
      console.error(e2);
      show(err, `⚠️ Connection error: ${String(e2)}`);
    } finally {
      btn.disabled = false; btn.textContent = 'Check status';
    }
  }

  // Wire up events
  btn.addEventListener('click', handleCheck);
  form.addEventListener('submit', handleCheck); // supports Enter key
});
</script>
